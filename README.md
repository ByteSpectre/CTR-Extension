# CTR-Extension

**CTR-Extension** – это расширение для браузера Chrome, разработанное для продавцов Avito Pro, которое помогает рассчитывать и отображать CTR (Click-Through Rate) для объявлений, а также генерировать отчёты в формате Excel (XLSX).

## Основные возможности

- **Расчёт CTR для объявления**  
  Расширение получает статистические данные (показы, просмотры, контакты и др.) с API Avito и вычисляет CTR по дням.  
  - **Ежедневный CTR:** Выводится под столбцами статистики для каждого дня.
  - **Конверсии:**  
    - Для показов: рассчитывается по формуле (просмотры / показы) * 100  
    - Для просмотров: рассчитывается по формуле (контакты / просмотры) * 100

- **Динамическое изменение периода статистики**  
  При изменении периода в URL расширения автоматически обновляют заголовок (например, «30 дней: 3 февраля – 4 марта» изменяется на соответствующий выбранному диапазону).

- **Обновление существующих UI-элементов**  
  Вместо создания новых блоков расширение обновляет уже существующие элементы в интерфейсе Avito (например, блоки с показателями «Показы», «Просмотры», «Контакты», «В избранное», «Расходы» и конверсии).

- **Генерация отчёта в формате XLSX**  
  Пользователь может скачать отчёт с рассчитанными данными CTR. При нажатии на кнопку отчёта текст меняется на «Подождите... идет генерация отчета», чтобы дать понять, что процесс запущен (отчёт может генерироваться долго при выборе длительного периода).

- **Агрегированный отчёт для всех объявлений**  
  Помимо отчёта по отдельному объявлению, реализована возможность скачивания агрегированного отчёта для всех объявлений, с использованием отдельного скрипта (aggregatedReport.js).

## Структура проекта

- **background.js**  
  Основной файл расширения, который отслеживает обновление вкладок и выполняет инъекцию скриптов на страницы Avito.  
  В нём реализована логика:
  - Определения URL объявления (с использованием регулярных выражений).
  - Извлечения параметров (ID объявления, даты начала и конца статистики) из URL.
  - Вызова функции `checkAndRunScript()`, которая обновляет элементы страницы (заголовок периода, показатели, конверсии, CTR и кнопку для скачивания отчёта).
  - Очистки ранее вставленных элементов, чтобы избежать дублирования при смене фильтров или периодов.

- **aggregatedReport.js**  
  Скрипт для генерации агрегированного отчёта по всем объявлениям.  
  Здесь реализована логика:
  - Получения параметров фильтрации (период, страница, сортировка).
  - Добавления кнопки для скачивания агрегированного отчёта.
  - Загрузки библиотеки XLSX (xlsx.full.min.js) для формирования Excel-файла.
  - Формирования запроса к API поиска и статистики, обработки полученных данных и формирования итогового отчёта.

- **lib/xlsx.full.min.js**  
  Библиотека для работы и генерации Excel (XLSX). Загружается динамически, если её ещё нет на странице.

## Пошаговое описание работы расширения

1. **Отслеживание обновлений вкладок**  
   В файле `background.js` с помощью `chrome.tabs.onUpdated.addListener` происходит проверка URL. Если URL соответствует странице с деталями объявления Avito Pro, выполняется функция `checkAndRunScript()`.

2. **Очистка ранее вставленных элементов**  
   При запуске `checkAndRunScript()` сначала удаляются уже добавленные элементы (например, контейнер CTR, кнопка скачивания, элементы статистики). Это гарантирует, что при смене периода или фильтров на странице не будет дублирования элементов.

3. **Извлечение параметров из URL**  
   Скрипт получает ID объявления и даты статистики (период) из URL страницы. Если параметры не найдены, выводится предупреждение.

4. **Обновление заголовка периода**  
   Функция `changePeriodTitle()` преобразует даты в человекочитаемый формат (например, «30 дней: 3 февраля — 4 марта») и обновляет текст заголовка на странице.

5. **Запрос статистики с API Avito**  
   С помощью fetch-POST запроса на URL `https://www.avito.ru/web/2/sellers/pro/statistics/item` расширение получает статистические данные (массив с данными по дням, а также объекты `funnelSteps` и `funnelCounters`).

6. **Обновление UI-элементов**  
   - **Показы, Просмотры, Контакты:** Значения обновляются в существующих элементах страницы, используя обращение данным `funnelSteps`.  
   - **В избранное и Расходы:** Значения обновляются в блоке, расположенном в соответствующем контейнере, с использованием запроса и данных из `funnelCounters`.  
   - **Конверсии:** Рассчитываются по формулам:
     - Для показов: (просмотры / показы) * 100  
     - Для просмотров: (контакты / просмотры) * 100  
     Результаты выводятся в соответствующих контейнерах в процентах.

7. **Отображение CTR**  
   Функция `calculateCTR()` обрабатывает данные по каждому дню, рассчитывая CTR и формируя массив для отображения. Полученные результаты выводятся под графиком статистики.

8. **Кнопка скачивания отчёта**  
   В заголовке статистики добавляется кнопка «Скачать CTR отчет». При клике на неё:
   - Если библиотека XLSX не загружена, она загружается динамически.
   - Кнопка переводится в состояние disabled и её текст меняется на «Подождите... идет генерация отчета».
   - После генерации отчёта (формирование Excel-файла с данными CTR) файл скачивается, а кнопка возвращается в исходное состояние.

9. **Агрегированный отчёт**  
   В файле `aggregatedReport.js` реализована логика для скачивания агрегированного отчёта по всем объявлениям. Пользователь нажимает кнопку, после чего формируется Excel-файл с данными для каждого объявления за выбранный период.

## Установка и запуск

1. Склонируйте репозиторий:  
   ```bash
   git clone https://github.com/ByteSpectre/CTR-Extension.git
   ```

2. Откройте Chrome и перейдите на страницу расширений (`chrome://extensions`).

3. Включите режим разработчика и загрузите распакованное расширение, выбрав папку с проектом.

4. Перейдите на сайт Avito Pro, откройте страницу с объявлением или статистикой, и расширение автоматически выполнит свою логику.

## Заключение

Расширение CTR-Extension помогает быстро получать актуальные данные по CTR для объявлений на Avito Pro, обновляет UI-элементы с реальными статистическими значениями, рассчитывает конверсии и предоставляет возможность скачивать отчёты в формате XLSX.
